'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import Image from 'next/image';
import VoteStamp from './VoteStamp';
import VoteButton from './VoteButton';

// Inline SearchBar component with Figma-accurate spacing
function SearchBar({ 
  value, 
  onChange, 
  placeholder = "애니메이션 이름을 입력하세요" 
}: {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}) {
  return (
    <div className="flex items-center gap-[16px] flex-1">
      {/* Search Icon */}
      <div className="w-[20px] h-[20px] flex-shrink-0">
        <Image
          src="/icons/voteSection-search.svg"
          alt="Search Icon"
          width={20}
          height={20}
          className="w-full h-full"
        />
      </div>
      
      {/* Search Input */}
      <div className="flex-1 max-w-[380px]">
        <div className="relative">
          <input
            type="text"
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            className="w-full h-[40px] px-[16px] py-[8px] bg-white border-b-2 border-[#990033] outline-none text-[14px] placeholder-gray-400"
          />
        </div>
      </div>
    </div>
  );
}

interface VoteSectionProps {
  currentVotes?: number;
  maxVotes?: number;
  bonusVotesUsed?: number;
  searchQuery?: string;
  gender?: 'male' | 'female';
  hasClickedBonus?: boolean;
  onSearchQueryChange?: (query: string) => void;
  onNextClick?: () => void;
  onBonusClick?: () => void;
  onSubmitClick?: () => void;
  external?: boolean;
}

export default function VoteSection({
  currentVotes: externalCurrentVotes = 0,
  maxVotes: externalMaxVotes = 10,
  bonusVotesUsed: externalBonusVotesUsed = 0,
  searchQuery: externalSearchQuery = '',
  gender: externalGender = 'male',
  hasClickedBonus: externalHasClickedBonus = false,
  onSearchQueryChange,
  onNextClick,
  onBonusClick,
  onSubmitClick,
  external = false
}: VoteSectionProps) {
  // Internal state for testing
  const [internalCurrentVotes, setInternalCurrentVotes] = useState(0);
  const [internalBonusVotesUsed, setInternalBonusVotesUsed] = useState(0);
  const [internalSearchQuery, setInternalSearchQuery] = useState('');
  const [internalGender, setInternalGender] = useState<'male' | 'female'>('male');
  const [internalHasClickedBonus, setInternalHasClickedBonus] = useState(false);
  const [hasReachedMaxVotes, setHasReachedMaxVotes] = useState(false); // 한번 true가 되면 계속 유지
  const [showBonusTooltip, setShowBonusTooltip] = useState(true); // 보너스 도장 말풍선 표시 여부
  const [showGenderSelection, setShowGenderSelection] = useState(false); // 네 번째 상태: 성별 입력

  // Use external or internal state based on external prop
  const currentVotes = external ? externalCurrentVotes : internalCurrentVotes;
  const maxVotes = externalMaxVotes;
  const bonusVotesUsed = external ? externalBonusVotesUsed : internalBonusVotesUsed;
  const searchQuery = external ? externalSearchQuery : internalSearchQuery;
  const gender = external ? externalGender : internalGender;
  const hasClickedBonus = external ? externalHasClickedBonus : internalHasClickedBonus;

  // Check if max votes reached and update state permanently
  useEffect(() => {
    if (currentVotes >= maxVotes && !hasReachedMaxVotes) {
      setHasReachedMaxVotes(true);
    }
  }, [currentVotes, maxVotes, hasReachedMaxVotes]);

  // Derived states
  const isBonusMode = hasReachedMaxVotes && hasClickedBonus;

  // Vote stamp states
  const isNormalVoteActive = currentVotes < maxVotes; // maxVotes 미만이면 빨강, 이상이면 회색

  // Event handlers
  const handleSearchQueryChange = (query: string) => {
    if (external && onSearchQueryChange) {
      onSearchQueryChange(query);
    } else {
      setInternalSearchQuery(query);
    }
  };

  const handleNextClick = () => {
    if (external && onNextClick) {
      onNextClick();
    } else {
      // 모든 상태에서 NEXT 클릭 시 네 번째 상태로 전환
      setShowGenderSelection(true);
    }
  };

  const handleBonusClick = () => {
    if (external && onBonusClick) {
      onBonusClick();
    } else {
      setInternalHasClickedBonus(true);
    }
  };

  const handleSubmitClick = () => {
    if (external && onSubmitClick) {
      onSubmitClick();
    } else {
      setShowGenderSelection(true); // 성별 입력 상태로 전환
    }
  };

  const handleGenderSelect = (selectedGender: 'male' | 'female') => {
    setInternalGender(selectedGender);
    setShowGenderSelection(false);
    console.log('Final submit with gender:', selectedGender);
  };

  return (
    <div className="w-full bg-white rounded-[8px] shadow-sm border border-gray-200">
      {/* Notification Section */}
      <div className="flex flex-col gap-2.5 pb-[15px] pl-6 pr-[58px] pt-3">
        <div className="bg-[#f1f2f3] flex h-9 items-center justify-start pl-2 pr-5 py-0 rounded-lg w-fit">
          <div className="flex gap-2.5 items-center justify-start px-2.5 py-0">
            <div className="relative size-4 overflow-hidden">
              <Image
                src="/icons/voteSection-notify-icon.svg"
                alt="Notification Icon"
                width={16}
                height={16}
                className="w-full h-full"
              />
            </div>
          </div>
          <div className="flex flex-col font-['Pretendard',_sans-serif] font-semibold justify-center text-[#23272b] text-base">
            <p className="leading-normal whitespace-pre">
              {showGenderSelection ? "성별은 투표 성향 통계에 꼭 필요한 정보예요." : "분기 신작 애니메이션을 투표해주세요!"}
            </p>
          </div>
        </div>
      </div>
      
      {/* Separator */}
      <div className="max-w-[1240px] mx-auto h-0 w-full">
        <div className="w-full h-px bg-[#e9ecef]" />
      </div>
      
      {/* Main Container - 1240px max-width with responsive spacing */}
      <div className="max-w-[1240px] mx-auto flex flex-col lg:flex-row items-center justify-between gap-8 lg:gap-16 p-6">
        
        {/* Search Bar Section - Hidden in Gender Selection */}
        {!showGenderSelection && (
          <SearchBar
            value={searchQuery}
            onChange={handleSearchQueryChange}
          />
        )}

        {/* Vote Status and Buttons Section - Fixed height for consistent layout */}
        <div className="flex items-center gap-4 lg:gap-8 h-16 overflow-visible">
          
          {/* Gender Selection UI - Fourth State */}
          {showGenderSelection ? (
            <div className="w-full flex justify-center items-center px-14 py-2.5">
              {/* Left Area: Fixed width container */}
              <div className="w-[822px] h-16 flex justify-start items-center gap-11">
                  {/* BACK Button */}
                  <motion.button
                    className="bg-gradient-to-r from-[#adb5bd] to-[#868e96] text-white font-bold text-base px-2.5 py-2.5 rounded-lg"
                    initial={{ opacity: 0, x: -100 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ 
                      type: "spring", 
                      stiffness: 300, 
                      damping: 30,
                      duration: 0.5
                    }}
                    onClick={() => setShowGenderSelection(false)}
                  >
                    BACK
                  </motion.button>
                  
                  {/* Vote Stamps Container */}
                  <div className="size- flex justify-start items-center gap-10">
                    {/* Normal Vote Stamp */}
                    <motion.div
                      className="w-52 flex justify-start items-center gap-5"
                      initial={{ x: 0 }}
                      animate={{ 
                        x: isBonusMode ? -20 : 0
                      }}
                      transition={{ 
                        type: "spring", 
                        stiffness: 300, 
                        damping: 30,
                        duration: 0.5
                      }}
                    >
                      <VoteStamp
                        type="normal"
                        isActive={isNormalVoteActive}
                        currentVotes={currentVotes}
                        maxVotes={maxVotes}
                      />
                    </motion.div>

                    {/* Bonus Vote Stamp */}
                    {isBonusMode && (
                      <motion.div
                        className="size- flex justify-start items-center gap-5"
                        initial={{ 
                          opacity: 0, 
                          scale: 0.8, 
                          x: 50 
                        }}
                        animate={{ 
                          opacity: 1, 
                          scale: 1, 
                          x: 0 
                        }}
                        transition={{ 
                          type: "spring", 
                          stiffness: 300, 
                          damping: 30,
                          duration: 0.5
                        }}
                      >
                        <VoteStamp
                          type="bonus"
                          isActive={true}
                          currentVotes={currentVotes}
                          maxVotes={maxVotes}
                          bonusVotesUsed={bonusVotesUsed}
                        />
                      </motion.div>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Right Area: Gender Selection and Submit Button */}
              <div className="flex justify-end items-center gap-12">
                {/* Gender Selection Toggles */}
                <div className="flex justify-center items-center gap-9">
                  {/* Male Toggle */}
                  <motion.div
                    className="flex justify-start items-center gap-1 overflow-hidden"
                    initial={{ opacity: 0, x: 50 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ 
                      type: "spring", 
                      stiffness: 300, 
                      damping: 30,
                      duration: 0.5
                    }}
                  >
                    <div className="justify-center text-black text-2xl font-semibold font-['Pretendard']">남성</div>
                    <div className="relative shrink-0 size-[22px]">
                      <Image
                        src="/icons/voteSection-selected.svg"
                        alt="Male Selected"
                        width={22}
                        height={22}
                        className="w-full h-full"
                      />
                    </div>
                  </motion.div>
                  
                  {/* Female Toggle */}
                  <motion.div
                    className="flex justify-start items-center gap-1 overflow-hidden"
                    initial={{ opacity: 0, x: 50 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ 
                      type: "spring", 
                      stiffness: 300, 
                      damping: 30,
                      duration: 0.5
                    }}
                  >
                    <div className="justify-center text-black text-2xl font-semibold font-['Pretendard']">여성</div>
                    <button 
                      className="block cursor-pointer overflow-visible relative shrink-0 size-[22px]"
                      onClick={() => handleGenderSelect('female')}
                    >
                      <Image
                        src="/icons/voteSection-default.svg"
                        alt="Female Default"
                        width={22}
                        height={22}
                        className="w-full h-full"
                      />
                    </button>
                  </motion.div>
                </div>
                
                {/* Submit Button - No animation, stays in place */}
                <button
                  data-property-1="submit" 
                  className="pl-2.5 pr-3 py-2.5 bg-gradient-to-r from-pink-700 to-pink-800 rounded-lg flex justify-start items-start gap-2.5"
                  onClick={() => handleGenderSelect('male')}
                >
                  <div className="justify-center text-white text-base font-bold font-['Pretendard']">제출하기</div>
                </button>
              </div>
            </div>
          ) : (
            /* Vote Stamps and Buttons Container - Simple flex layout with fixed height */
            <div className={`flex items-center h-16 overflow-visible ${isBonusMode ? 'gap-6 lg:gap-12' : 'gap-4 lg:gap-8'}`}>
            
              {/* Normal Vote Stamp with Slide Animation */}
              <motion.div
                layout
                initial={{ x: 0 }}
                animate={{ 
                  x: isBonusMode ? -20 : 0
                }}
                transition={{ 
                  type: "spring", 
                  stiffness: 300, 
                  damping: 30,
                  duration: 0.5
                }}
              >
                <VoteStamp
                  type="normal"
                  isActive={isNormalVoteActive}
                  currentVotes={currentVotes}
                  maxVotes={maxVotes}
                />
              </motion.div>

              {/* Bonus Vote Stamp - Smooth Entrance Animation */}
              {isBonusMode && (
                <motion.div
                  className="relative"
                  initial={{ 
                    opacity: 0, 
                    scale: 0.8, 
                    x: 50 
                  }}
                  animate={{ 
                    opacity: 1, 
                    scale: 1, 
                    x: 0 
                  }}
                  transition={{ 
                    type: "spring", 
                    stiffness: 300, 
                    damping: 30,
                    duration: 0.6
                  }}
                >
                  {/* Tooltip for Bonus Vote Stamp */}
                  {showBonusTooltip && (
                    <div className="absolute bottom-full mb-[15px] left-8 transform -translate-x-1/2 translate-y-0.5 z-10">
                      <div className="relative w-max">
                        <img
                          src="/icons/textBalloon-long.svg"
                          alt="Text Balloon Long"
                          height={55}
                          className="w-auto h-auto"
                          style={{
                            filter: 'drop-shadow(2px 2px 4px rgba(0,0,0,0.15))'
                          }}
                        />
                        
                        {/* Text overlay */}
                        <div className="absolute inset-0 flex items-center justify-center px-6 py-2 -translate-y-1">
                          <div className="flex flex-col font-['Pretendard',_sans-serif] font-normal justify-center text-[#000000] text-base">
                            <p className="leading-[22px] whitespace-pre">보너스 표는 2개가 모여야 일반 표 1개와 같습니다.</p>
                          </div>
                        </div>
                        
                        {/* Hide notification button */}
                        <div className="absolute top-1 right-1">
                          <motion.button
                            className="w-4 h-4 flex items-center justify-center"
                            whileHover={{ scale: 1.1 }}
                            whileTap={{ scale: 0.9 }}
                            onClick={() => {
                              setShowBonusTooltip(false);
                            }}
                          >
                            <Image
                              src="/icons/voteSection-notify-hide.svg"
                              alt="Hide Notification"
                              width={16}
                              height={16}
                              className="w-full h-full"
                            />
                          </motion.button>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <VoteStamp
                    type="bonus"
                    isActive={true}
                    currentVotes={currentVotes}
                    maxVotes={maxVotes}
                    bonusVotesUsed={bonusVotesUsed}
                  />
                </motion.div>
              )}

              {/* Action Buttons */}
              {hasReachedMaxVotes && !hasClickedBonus ? (
                <>
                  <motion.div
                    className="relative"
                    initial={{ 
                      opacity: 0, 
                      scale: 0.9, 
                      x: 15,
                      rotate: -2
                    }}
                    animate={{ 
                      opacity: 1, 
                      scale: 1, 
                      x: 0,
                      rotate: 0
                    }}
                    transition={{ 
                      type: "spring", 
                      stiffness: 400, 
                      damping: 25,
                      duration: 0.5
                    }}
                    whileHover={{ 
                      scale: 1.05,
                      rotate: 1,
                      transition: { duration: 0.2 }
                    }}
                  >
                    {/* Tooltip for BONUS button */}
                    <div className="absolute bottom-full mb-[15px] left-1/2 transform -translate-x-1/2 translate-y-1 z-10">
                      <div className="relative w-max">
                        <img
                          src="/icons/textBalloon.svg"
                          alt="Text Balloon"
                          className="w-auto h-auto"
                          style={{
                            filter: 'drop-shadow(2px 2px 4px rgba(0,0,0,0.15))'
                          }}
                        />
                        
                        {/* Text overlay */}
                        <div className="absolute inset-0 flex items-center justify-center px-8 py-3 -translate-y-1">
                          <div className="flex flex-col font-['Pretendard',_sans-serif] font-normal justify-center text-[#000000] text-base">
                            <p className="leading-[22px] whitespace-pre">더 투표하고 싶으신가요?</p>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <VoteButton
                      type="bonus"
                      onClick={handleBonusClick}
                    />
                  </motion.div>
                  <VoteButton
                    type="next"
                    onClick={handleNextClick}
                  />
                </>
              ) : (
                <VoteButton
                  type="next"
                  onClick={handleNextClick}
                />
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
