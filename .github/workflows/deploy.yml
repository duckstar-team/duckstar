name: Deploy Duckstar

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
      SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      KAKAO_ADMIN_KEY: ${{ secrets.KAKAO_ADMIN_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get public IP of GitHub Actions runner
        id: ip
        run: echo "IP=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Add IP to EC2 Security Group for SSH
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id sg-01655f148522c2cac \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.IP }}/32
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2 via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
            set -e
            cd /home/ubuntu/duckstar

            echo "ğŸ”„ Git Pulling..."
            git fetch origin master
            git reset --hard origin/master

            echo "ğŸ” .env ìƒì„±"
            echo "SPRING_PROFILES_ACTIVE=$SPRING_PROFILES_ACTIVE" > .env
            echo "SPRING_DATASOURCE_URL=$SPRING_DATASOURCE_URL" >> .env
            echo "SPRING_DATASOURCE_USERNAME=$SPRING_DATASOURCE_USERNAME" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=$SPRING_DATASOURCE_PASSWORD" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "KAKAO_ADMIN_KEY=$KAKAO_ADMIN_KEY" >> .env

            # ì¼ë°˜ì ì¸ ë°°í¬ (ë¬´ì¤‘ë‹¨)
            echo "ğŸ›  ë¹Œë“œ ì‹œì‘"
            docker compose up -d --build

            echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker compose up -d

            echo "ğŸ§¹ ì•ˆ ì“°ëŠ” ì´ë¯¸ì§€ ì •ë¦¬"
            docker image prune -f

            echo "ğŸ“‹ í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ"
            docker ps -a

            echo "ğŸ“„ ìµœê·¼ ë¡œê·¸ ì¶œë ¥"
            docker compose logs --tail=50
          EOF