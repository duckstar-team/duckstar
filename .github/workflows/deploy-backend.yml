name: Deploy Backend

on:
  push:
    branches: [ "master" ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
    # ÏàòÎèô ÍπÉÏï°ÏÖò
    workflow_dispatch:

# ÎèôÏãú Î∞∞Ìè¨ Ï†úÏñ¥: Í∞ôÏùÄ EC2 Ïù∏Ïä§ÌÑ¥Ïä§Ïóê ÎåÄÌïú Î∞∞Ìè¨Îäî ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§Ìñâ
concurrency:
  group: deploy-backend
  cancel-in-progress: false # ÏßÑÌñâ Ï§ëÏù∏ Î∞∞Ìè¨Îäî Ï∑®ÏÜåÌïòÏßÄ ÏïäÍ≥† ÎåÄÍ∏∞

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Discord Notification - Î∞∞Ìè¨ ÏãúÏûë
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "üöÄ Backend Î∞∞Ìè¨ ÏãúÏûë",
              "color": 3447003,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "${{ github.sha }}", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. ÏïÑÌã∞Ìå©Ìä∏ ÎπåÎìú (JAR ÏÉùÏÑ±)
      - name: Build with Gradle
        run: |
          cd backend
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # 2. ÎèÑÏª§ ÌóàÎ∏å Î°úÍ∑∏Ïù∏ Î∞è Ïù¥ÎØ∏ÏßÄ Ìë∏Ïãú
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/duckstar-docker-hub:backend

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Get public IP of GitHub Actions runner
        id: ip
        run: echo "IP=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Add IP to EC2 Security Group for SSH
        id: add_ip
        run: |
          # ÌòÑÏû¨ IPÍ∞Ä Ïù¥ÎØ∏ Î≥¥Ïïà Í∑∏Î£πÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
          if aws ec2 describe-security-groups \
            --group-ids sg-01655f148522c2cac \
            --query "SecurityGroups[0].IpPermissions[?IpRanges[?CidrIp=='${{ steps.ip.outputs.IP }}/32']]" \
            --output text | grep -q "${{ steps.ip.outputs.IP }}/32"; then
            echo "IP ${{ steps.ip.outputs.IP }} is already in the security group"
            echo "ip_added=false" >> $GITHUB_OUTPUT
          else
            echo "Adding IP ${{ steps.ip.outputs.IP }} to security group"
            aws ec2 authorize-security-group-ingress \
              --group-id sg-01655f148522c2cac \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.IP }}/32
            echo "ip_added=true" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/duckstar

            # 0. docker-compose.yml ÌååÏùº ÏÉùÏÑ±
            cat <<'DOCKER_COMPOSE_EOF' > docker-compose.yml
            services:
              backend:
                image: ${DOCKERHUB_USERNAME}/duckstar-docker-hub:backend
                container_name: duckstar-backend
                env_file:
                  - .env.backend
                environment:
                  SPRING_PROFILES_ACTIVE: prod
                expose:
                  - '8080'
                restart: always
                deploy:
                  resources:
                    limits:
                      memory: 1280M
                    reservations:
                      memory: 512M
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s
                networks:
                  - duckstar-net

              frontend:
                image: ${DOCKERHUB_USERNAME}/duckstar-docker-hub:frontend
                container_name: duckstar-frontend
                expose:
                  - '3000'
                restart: always
                deploy:
                  resources:
                    limits:
                      memory: 512M
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 30s
                networks:
                  - duckstar-net
                volumes:
                  - frontend-static:/app/.next/static
                  - frontend-public:/app/public

              nginx:
                image: nginx:stable-alpine
                container_name: duckstar-nginx
                volumes:
                  - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
                  - /etc/letsencrypt:/etc/letsencrypt
                  - frontend-static:/app/.next/static:ro
                  - frontend-public:/app/public:ro
                ports:
                  - '80:80'
                  - '443:443'
                depends_on:
                  backend:
                    condition: service_healthy
                  frontend:
                    condition: service_healthy
                restart: always
                deploy:
                  resources:
                    limits:
                      memory: 128M
                    reservations:
                      memory: 64M
                healthcheck:
                  test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
                  interval: 30s
                  timeout: 5s
                  retries: 3
                networks:
                  - duckstar-net

            networks:
              duckstar-net:
                driver: bridge

            volumes:
              frontend-static:
              frontend-public:
            DOCKER_COMPOSE_EOF

            # 1. .env ÌååÏùº ÏÉùÏÑ± (ÎèÑÏª§ ÏïÑÏù¥ÎîîÏôÄ ÏÑúÎπÑÏä§ ÌôòÍ≤ΩÎ≥ÄÏàò Ï£ºÏûÖ)
            cat <<EOF > .env.backend
            SPRING_PROFILES_ACTIVE=prod
            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            SECURITY_IP_HASH_KEY=${{ secrets.SECURITY_IP_HASH_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            KAKAO_ADMIN_KEY=${{ secrets.KAKAO_ADMIN_KEY }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_KAKAO_APP_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_APP_KEY }}
            EOF
            
            # 2. Ïù¥ÎØ∏ÏßÄ ÌíÄ Î∞è Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë
            echo "üì• ÏµúÏã† Ïù¥ÎØ∏ÏßÄ Pull Ï§ë..."
            docker compose pull backend
            
            echo "üõ† Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë Ï§ë..."
            # --no-depsÎ°ú nginxÎäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÍ≥† backendÎßå Ïû¨ÏãúÏûë
            docker compose up -d --no-deps backend
            
            echo "üßπ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎäî Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨ Ï§ë..."
            docker image prune -f
            
      # üè• Ìó¨Ïä§Ï≤¥ÌÅ¨ Îã®Í≥Ñ
      - name: Health Check
        id: health_check
        run: |
          MAX_ATTEMPTS=12
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Checking health... (attempt $i of $MAX_ATTEMPTS)"
            
            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            CONTAINER_STATUS=$(ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
              "docker ps -a --filter name=duckstar-backend --format '{{.Status}}'" 2>&1)
            echo "Container status: $CONTAINER_STATUS"
            
            # Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
            if ! ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
              "docker ps --filter name=duckstar-backend --format '{{.Names}}' | grep -q duckstar-backend"; then
              echo "‚ö†Ô∏è Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä Ïã§Ìñâ Ï§ëÏù¥ ÏïÑÎãôÎãàÎã§. Î°úÍ∑∏ ÌôïÏù∏ Ï§ë..."
              ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
                "docker logs duckstar-backend --tail 50" || true
              sleep 5
              continue
            fi
            
            # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìñâ (wget ÏÇ¨Ïö© - docker-compose.ymlÏùò healthcheckÏôÄ ÎèôÏùº)
            if ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
             "docker exec duckstar-backend \
              wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health 2>&1"; then
              echo "‚úÖ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "‚ö†Ô∏è Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®. Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏ ÌôïÏù∏ Ï§ë..."
              ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
                "docker logs duckstar-backend --tail 20" || true
            fi
            sleep 5
          done
          echo "‚ùå Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® (ÏµúÎåÄ ÏãúÎèÑ ÌöüÏàò Ï¥àÍ≥º)"
          echo "ÏµúÏ¢Ö Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏:"
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
            "docker logs duckstar-backend --tail 50" || true
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Discord Notification - Î∞∞Ìè¨ ÏÑ±Í≥µ
        if: steps.health_check.outputs.status == 'success'
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "‚úÖ Backend Î∞∞Ìè¨ ÏÑ±Í≥µ",
              "color": 3066993,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true},
                {"name": "Ìó¨Ïä§Ï≤¥ÌÅ¨", "value": "‚úÖ ÌÜµÍ≥º", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Discord Notification - Î∞∞Ìè¨ Ïã§Ìå®
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "‚ùå Backend Î∞∞Ìè¨ Ïã§Ìå®",
              "color": 15158332,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Remove IP from EC2 Security Group
        if: always() && steps.add_ip.outputs.ip_added == 'true'
        run: |
          echo "Removing IP ${{ steps.ip.outputs.IP }} from security group"
          aws ec2 revoke-security-group-ingress \
            --group-id sg-01655f148522c2cac \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.IP }}/32 || echo "Failed to remove IP (may have been removed already)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2