name: Deploy Backend

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

# ÎèôÏãú Î∞∞Ìè¨ Ï†úÏñ¥: Í∞ôÏùÄ EC2 Ïù∏Ïä§ÌÑ¥Ïä§Ïóê ÎåÄÌïú Î∞∞Ìè¨Îäî ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§Ìñâ
concurrency:
  group: deploy-ec2
  cancel-in-progress: false  # ÏßÑÌñâ Ï§ëÏù∏ Î∞∞Ìè¨Îäî Ï∑®ÏÜåÌïòÏßÄ ÏïäÍ≥† ÎåÄÍ∏∞

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    env:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
      SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
      SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      SECURITY_IP_HASH_KEY: ${{ secrets.SECURITY_IP_HASH_KEY }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
      NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
      KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
      KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
      KAKAO_ADMIN_KEY: ${{ secrets.KAKAO_ADMIN_KEY }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Discord Notification - Î∞∞Ìè¨ ÏãúÏûë
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "üöÄ Backend Î∞∞Ìè¨ ÏãúÏûë",
                   "color": 3447003,
                   "fields": [
                     {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "Ïª§Î∞ã", "value": "${{ github.sha }}", "inline": false},
                     {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true}
                   ],
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Get public IP of GitHub Actions runner
        id: ip
        run: echo "IP=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Add IP to EC2 Security Group for SSH
        id: add_ip
        run: |
          # ÌòÑÏû¨ IPÍ∞Ä Ïù¥ÎØ∏ Î≥¥Ïïà Í∑∏Î£πÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
          if aws ec2 describe-security-groups \
            --group-ids sg-01655f148522c2cac \
            --query "SecurityGroups[0].IpPermissions[?IpRanges[?CidrIp=='${{ steps.ip.outputs.IP }}/32']]" \
            --output text | grep -q "${{ steps.ip.outputs.IP }}/32"; then
            echo "IP ${{ steps.ip.outputs.IP }} is already in the security group"
            echo "ip_added=false" >> $GITHUB_OUTPUT
          else
            echo "Adding IP ${{ steps.ip.outputs.IP }} to security group"
            aws ec2 authorize-security-group-ingress \
              --group-id sg-01655f148522c2cac \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.IP }}/32
            echo "ip_added=true" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Create .env file
        run: |
          cat <<EOF > .env
          SPRING_PROFILES_ACTIVE=${{ env.SPRING_PROFILES_ACTIVE }}
          SPRING_DATASOURCE_URL=${{ env.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME=${{ env.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ env.SPRING_DATASOURCE_PASSWORD }}
          JWT_SECRET=${{ env.JWT_SECRET }}
          SECURITY_IP_HASH_KEY=${{ env.SECURITY_IP_HASH_KEY }}
          GOOGLE_CLIENT_ID=${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ env.GOOGLE_CLIENT_SECRET }}
          NAVER_CLIENT_ID=${{ env.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ env.NAVER_CLIENT_SECRET }}
          KAKAO_CLIENT_ID=${{ env.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ env.KAKAO_CLIENT_SECRET }}
          KAKAO_ADMIN_KEY=${{ env.KAKAO_ADMIN_KEY }}
          NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}
          EOF

      - name: Git pulling
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
            set -e
            cd /home/ubuntu/duckstar

            echo "üîÑ Git Pulling..."
            # Ï†ÑÏ≤¥ Î†àÌè¨ pull (docker-compose.ymlÍ≥º .env ÌååÏùº ÌïÑÏöî)
            git fetch origin master
            git reset --hard origin/master
          EOF

      - name: Upload .env to EC2
        run: scp -o StrictHostKeyChecking=no .env ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/duckstar/.env

      - name: Deploy Backend to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
            set -e
            cd /home/ubuntu/duckstar

            echo "üõ† Î∞±ÏóîÎìú ÎπåÎìú ÏãúÏûë"
            docker compose up -d --build backend

            echo "üßπ Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨"
            docker image prune -f

            echo "üìã Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú"
            docker ps -a

            echo "üìÑ Î∞±ÏóîÎìú ÏµúÍ∑º Î°úÍ∑∏"
            docker compose logs --tail=50 backend
          EOF

      - name: Health Check
        id: health_check
        run: |
          echo "üè• Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏãúÏûë..."
          MAX_ATTEMPTS=12
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏãúÎèÑ $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Nginx Ïª®ÌÖåÏù¥ÎÑàÎ•º ÌÜµÌï¥ Î∞±ÏóîÎìú Ìó¨Ïä§Ï≤¥ÌÅ¨ (Docker ÎÑ§Ìä∏ÏõåÌÅ¨ ÎÇ¥Î∂ÄÏóêÏÑú backend:8080 Ï†ëÍ∑º)
            if ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
              "docker exec duckstar-nginx curl -f -s http://backend:8080/actuator/health > /dev/null 2>&1"; then
              echo "‚úÖ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ ÏÑúÎπÑÏä§ Ï§ÄÎπÑ Ï§ë... 5Ï¥à ÎåÄÍ∏∞"
              sleep 5
            fi
          done
          
          echo "‚ùå Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®: 60Ï¥à ÎÇ¥Ïóê ÏÑúÎπÑÏä§Í∞Ä ÏùëÎãµÌïòÏßÄ ÏïäÏùå"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Discord Notification - Î∞∞Ìè¨ ÏÑ±Í≥µ
        if: steps.health_check.outputs.status == 'success'
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "‚úÖ Backend Î∞∞Ìè¨ ÏÑ±Í≥µ",
                   "color": 3066993,
                   "fields": [
                     {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                     {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true},
                     {"name": "Ìó¨Ïä§Ï≤¥ÌÅ¨", "value": "‚úÖ ÌÜµÍ≥º", "inline": true}
                   ],
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Discord Notification - Î∞∞Ìè¨ Ïã§Ìå®
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "‚ùå Backend Î∞∞Ìè¨ Ïã§Ìå®",
                   "color": 15158332,
                   "fields": [
                     {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                     {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true},
                     {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ],
                   "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Remove IP from EC2 Security Group
        if: always() && steps.add_ip.outputs.ip_added == 'true'
        run: |
          echo "Removing IP ${{ steps.ip.outputs.IP }} from security group"
          aws ec2 revoke-security-group-ingress \
            --group-id sg-01655f148522c2cac \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.IP }}/32 || echo "Failed to remove IP (may have been removed already)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

