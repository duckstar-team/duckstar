name: Deploy Frontend

on:
  push:
    branches:
      - master
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/deploy-frontend.yml'

# ÎèôÏãú Î∞∞Ìè¨ Ï†úÏñ¥: Í∞ôÏùÄ EC2 Ïù∏Ïä§ÌÑ¥Ïä§Ïóê ÎåÄÌïú Î∞∞Ìè¨Îäî ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§Ìñâ
concurrency:
  group: deploy-ec2
  cancel-in-progress: false # ÏßÑÌñâ Ï§ëÏù∏ Î∞∞Ìè¨Îäî Ï∑®ÏÜåÌïòÏßÄ ÏïäÍ≥† ÎåÄÍ∏∞

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Discord Notification - Î∞∞Ìè¨ ÏãúÏûë
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "üöÄ Frontend Î∞∞Ìè¨ ÏãúÏûë",
              "color": 3447003,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "${{ github.sha }}", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Get public IP of GitHub Actions runner
        id: ip
        run: echo "IP=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Add IP to EC2 Security Group for SSH
        id: add_ip
        run: |
          # ÌòÑÏû¨ IPÍ∞Ä Ïù¥ÎØ∏ Î≥¥Ïïà Í∑∏Î£πÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
          if aws ec2 describe-security-groups \
            --group-ids sg-01655f148522c2cac \
            --query "SecurityGroups[0].IpPermissions[?IpRanges[?CidrIp=='${{ steps.ip.outputs.IP }}/32']]" \
            --output text | grep -q "${{ steps.ip.outputs.IP }}/32"; then
            echo "IP ${{ steps.ip.outputs.IP }} is already in the security group"
            echo "ip_added=false" >> $GITHUB_OUTPUT
          else
            echo "Adding IP ${{ steps.ip.outputs.IP }} to security group"
            aws ec2 authorize-security-group-ingress \
              --group-id sg-01655f148522c2cac \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.IP }}/32
            echo "ip_added=true" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Create .env file
        run: |
          cat <<EOF > .env
          SPRING_PROFILES_ACTIVE=prod
          SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          SECURITY_IP_HASH_KEY=${{ secrets.SECURITY_IP_HASH_KEY }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_ADMIN_KEY=${{ secrets.KAKAO_ADMIN_KEY }}
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_KAKAO_APP_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_APP_KEY }}
          EOF

      - name: Upload code to EC2
        run: |
          echo "üì¶ ÏΩîÎìú ÏïïÏ∂ï Ï§ë..."
          tar -czf /tmp/duckstar-code.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='backend/build' \
            --exclude='frontend/.next' \
            --exclude='frontend/node_modules' \
            frontend/ \
            docker-compose.yml \
            nginx/ \
            .env

          echo "üì§ EC2Î°ú ÏΩîÎìú Ï†ÑÏÜ° Ï§ë..."
          scp -o StrictHostKeyChecking=no /tmp/duckstar-code.tar.gz ubuntu@${{ secrets.EC2_HOST }}:/tmp/duckstar-code.tar.gz

          echo "üìÇ EC2ÏóêÏÑú Í∏∞Ï°¥ ÏΩîÎìú ÏÇ≠Ï†ú Î∞è ÏÉà ÏΩîÎìú ÏïïÏ∂ï Ìï¥Ï†ú Ï§ë..."
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /home/ubuntu/duckstar
          
          if [ -d "frontend" ]; then
            echo "frontend ÎÇ¥Ïùò publicÏùÑ Ï†úÏô∏ÌïòÍ≥† Ï†ïÎ¶¨ Ï§ë..."
            # public Ìè¥ÎçîÎßå ÎÇ®Í∏∞Í≥† ÎÇòÎ®∏ÏßÄ ÏÇ≠Ï†ú
            find frontend -mindepth 1 -maxdepth 1 ! -name 'public' -exec rm -rf {} +
          fi
          
          if [ -d "nginx" ]; then
            rm -rf nginx
          fi
          
          tar -xzf /tmp/duckstar-code.tar.gz -C /home/ubuntu/duckstar
          EOF

          # Î°úÏª¨ ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨
          rm -f /tmp/duckstar-code.tar.gz

      - name: Deploy Frontend and Nginx to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} <<'EOF'
          set -e
          cd /home/ubuntu/duckstar

          echo "üßπ ÎπåÎìú Í≥µÍ∞Ñ ÌôïÎ≥¥: Ïò§ÎûòÎêú ÎèÑÏª§ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ (ÎπåÎìú Ï†Ñ)"
          # Ï§ëÏßÄÎêú Ïª®ÌÖåÏù¥ÎÑàÎßå ÏÇ≠Ï†ú (Ïã§Ìñâ Ï§ëÏù∏ Ïª®ÌÖåÏù¥ÎÑàÎäî Ïú†ÏßÄ)
          docker container prune -f
          # ÌÉúÍ∑∏Í∞Ä ÏóÜÎäî(dangling) Ïù¥ÎØ∏ÏßÄÎßå ÏÇ≠Ï†ú (ÎπåÎìú Ï∫êÏãúÎäî Ïú†ÏßÄ)
          docker image prune -f
          # 24ÏãúÍ∞Ñ Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùÄ ÎπåÎìú Ï∫êÏãúÎßå ÏÇ≠Ï†ú (ÏµúÍ∑º Ï∫êÏãúÎäî Ïú†ÏßÄÌïòÏó¨ ÎπåÎìú ÏÜçÎèÑ Ìñ•ÏÉÅ)
          docker builder prune -f --filter "until=24h"

          echo "üõ† ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞è Nginx ÎπåÎìú ÏãúÏûë"
          # Ïù¥Ï†ú Íπ®ÎÅóÌïú ÏÉÅÌÉúÏóêÏÑú ÎπåÎìú
          docker compose up -d --build frontend nginx

          echo "üìã Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú"
          docker ps -a

          echo "üìÑ ÌîÑÎ°†Ìä∏ÏóîÎìú ÏµúÍ∑º Î°úÍ∑∏"
          docker compose logs --tail=50 frontend

          echo "üìÑ Nginx ÏµúÍ∑º Î°úÍ∑∏"
          docker compose logs --tail=50 nginx
          EOF

      - name: Discord Notification - Î∞∞Ìè¨ ÏÑ±Í≥µ
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "‚úÖ Frontend Î∞∞Ìè¨ ÏÑ±Í≥µ",
              "color": 3066993,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Discord Notification - Î∞∞Ìè¨ Ïã§Ìå®
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "‚ùå Frontend Î∞∞Ìè¨ Ïã§Ìå®",
              "color": 15158332,
              "fields": [
                {"name": "Î∏åÎûúÏπò", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Ïª§Î∞ã", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ÏûëÏÑ±Ïûê", "value": "${{ github.actor }}", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Remove IP from EC2 Security Group
        if: always() && steps.add_ip.outputs.ip_added == 'true'
        run: |
          echo "Removing IP ${{ steps.ip.outputs.IP }} from security group"
          aws ec2 revoke-security-group-ingress \
            --group-id sg-01655f148522c2cac \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.IP }}/32 || echo "Failed to remove IP (may have been removed already)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2
