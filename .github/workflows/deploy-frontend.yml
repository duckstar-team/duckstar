name: Deploy Frontend

on:
  push:
    branches: [ "master" ]
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/deploy-frontend.yml'

# ë™ì‹œ ë°°í¬ ì œì–´: ê°™ì€ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ë°°í¬ëŠ” ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
concurrency:
  group: deploy-ec2
  cancel-in-progress: false # ì§„í–‰ ì¤‘ì¸ ë°°í¬ëŠ” ì·¨ì†Œí•˜ì§€ ì•Šê³  ëŒ€ê¸°

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Discord Notification - ë°°í¬ ì‹œì‘
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "ğŸš€ Frontend ë°°í¬ ì‹œì‘",
              "color": 3447003,
              "fields": [
                {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ì»¤ë°‹", "value": "${{ github.sha }}", "inline": false},
                {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/duckstar-docker-hub:frontend
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_KAKAO_APP_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_APP_KEY }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Get public IP of GitHub Actions runner
        id: ip
        run: echo "IP=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

      - name: Add IP to EC2 Security Group for SSH
        id: add_ip
        run: |
          # í˜„ì¬ IPê°€ ì´ë¯¸ ë³´ì•ˆ ê·¸ë£¹ì— ìˆëŠ”ì§€ í™•ì¸
          if aws ec2 describe-security-groups \
            --group-ids sg-01655f148522c2cac \
            --query "SecurityGroups[0].IpPermissions[?IpRanges[?CidrIp=='${{ steps.ip.outputs.IP }}/32']]" \
            --output text | grep -q "${{ steps.ip.outputs.IP }}/32"; then
            echo "IP ${{ steps.ip.outputs.IP }} is already in the security group"
            echo "ip_added=false" >> $GITHUB_OUTPUT
          else
            echo "Adding IP ${{ steps.ip.outputs.IP }} to security group"
            aws ec2 authorize-security-group-ingress \
              --group-id sg-01655f148522c2cac \
              --protocol tcp \
              --port 22 \
              --cidr ${{ steps.ip.outputs.IP }}/32
            echo "ip_added=true" >> $GITHUB_OUTPUT
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
      
      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml" # ë¡œì»¬(Runner)ì˜ íŒŒì¼
          target: "/home/ubuntu/duckstar/" # EC2ì˜ ëª©ì ì§€
          
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/duckstar
            
            # 1. .env íŒŒì¼ ìƒì„± (ë„ì»¤ ì•„ì´ë””ì™€ ì„œë¹„ìŠ¤ í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
            cat <<EOF > .env
            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_KAKAO_APP_KEY=${{ secrets.NEXT_PUBLIC_KAKAO_APP_KEY }}
            EOF
            
            # 2. ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ Pull ì¤‘..."
            docker compose pull frontend nginx
            
            echo "ğŸ›  ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
            # Frontend ë¨¼ì € ì¬ì‹œì‘ (nginxëŠ” frontendê°€ healthy ë  ë•Œê¹Œì§€ ëŒ€ê¸°)
            docker compose up -d --no-deps frontend

            # Frontendê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ Frontend ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
            timeout 60 bash -c 'until docker exec duckstar-frontend wget --spider -q http://localhost:3000/; do sleep 2; done' || true
            
            # ê·¸ ë‹¤ìŒ nginx ì¬ì‹œì‘ (ìµœì†Œ ë‹¤ìš´íƒ€ì„)
            docker compose up -d --no-deps nginx
            
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f

      # ğŸ¥ í—¬ìŠ¤ì²´í¬ ë‹¨ê³„
      - name: Health Check
        id: health_check
        run: |
          MAX_ATTEMPTS=12
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Checking health... (attempt $i of $MAX_ATTEMPTS)"
            if ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
             "docker exec duckstar-frontend \
              wget --no-verbose --tries=1 --spider http://localhost:3000/ > /dev/null 2>&1"; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Discord Notification - ë°°í¬ ì„±ê³µ
        if: steps.health_check.outputs.status == 'success'
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "âœ… Frontend ë°°í¬ ì„±ê³µ",
              "color": 3066993,
              "fields": [
                {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ì»¤ë°‹", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                {"name": "í—¬ìŠ¤ì²´í¬", "value": "âœ… í†µê³¼", "inline": true}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Discord Notification - ë°°í¬ ì‹¤íŒ¨
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
            "embeds": [{
              "title": "âŒ Frontend ë°°í¬ ì‹¤íŒ¨",
              "color": 15158332,
              "fields": [
                {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ì»¤ë°‹", "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})", "inline": false},
                {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ìƒì„¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }]
          }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Remove IP from EC2 Security Group
        if: always() && steps.add_ip.outputs.ip_added == 'true'
        run: |
          echo "Removing IP ${{ steps.ip.outputs.IP }} from security group"
          aws ec2 revoke-security-group-ingress \
            --group-id sg-01655f148522c2cac \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.ip.outputs.IP }}/32 || echo "Failed to remove IP (may have been removed already)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2